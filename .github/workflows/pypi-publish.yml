name: Publish to PyPI

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0, v1.0.0-beta, etc.
  release:
    types: [published]
  workflow_dispatch:  # Allow manual triggering
    inputs:
      tag:
        description: 'Tag to publish (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  # Job 1: Test PyPI (for pre-release testing ONLY)
  publish-testpypi:
    runs-on: ubuntu-latest
    # Static environment name - this is crucial for secret access
    environment: testpypi
    # Only run for pre-release tags (beta, alpha, rc)
    if: contains(github.ref, '-beta') || contains(github.ref, '-alpha') || contains(github.ref, '-rc')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine setuptools wheel

    - name: Determine tag and version
      id: target
      run: |
        # Get the tag from either push event or manual input
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          TAG="${{ github.event.inputs.tag }}"
        else
          TAG="${GITHUB_REF#refs/tags/}"
        fi
        
        echo "tag=${TAG}" >> $GITHUB_OUTPUT
        echo "environment=testpypi" >> $GITHUB_OUTPUT
        echo "pypi_name=Test PyPI" >> $GITHUB_OUTPUT
        echo "pypi_url=https://test.pypi.org/project/ambivo-agents/" >> $GITHUB_OUTPUT
        echo "repository_url=https://test.pypi.org/legacy/" >> $GITHUB_OUTPUT
        echo "is_prerelease=true" >> $GITHUB_OUTPUT
        echo "install_cmd=pip install -i https://test.pypi.org/simple/ ambivo-agents==${TAG}" >> $GITHUB_OUTPUT
        
        echo "ğŸ¯ Target: Test PyPI (Pre-release Testing)"
        echo "ğŸ·ï¸ Version: ${TAG}"
        echo "ğŸŒ Environment: testpypi"
        echo "ğŸŒ Repository URL: https://test.pypi.org/legacy/"

    - name: Verify version tag
      run: |
        TAG="${{ steps.target.outputs.tag }}"
        echo "ğŸ·ï¸ Publishing pre-release version: ${TAG}"
        
        # Check if this is a valid pre-release version tag
        if [[ ${TAG} =~ ^v[0-9]+\.[0-9]+\.[0-9]+.*$ ]]; then
          echo "âœ… Valid pre-release version tag detected"
        else
          echo "âŒ Invalid version tag format: ${TAG}"
          echo "Expected format: v1.0.0-beta, v1.0.0-alpha, v1.0.0-rc1"
          exit 1
        fi

    - name: Check if version already exists
      run: |
        TAG="${{ steps.target.outputs.tag }}"
        PACKAGE_NAME="ambivo-agents"
        
        # Remove 'v' prefix for PyPI version check
        VERSION="${TAG#v}"
        
        echo "ğŸ” Checking if version ${VERSION} already exists on Test PyPI..."
        
        # Check Test PyPI (allow duplicates for testing)
        if pip index versions ${PACKAGE_NAME} --index-url https://test.pypi.org/simple/ 2>/dev/null | grep -q "${VERSION}"; then
          echo "âš ï¸ Version ${VERSION} already exists on Test PyPI"
          echo "â„¹ï¸ This is normal for Test PyPI - continuing anyway"
        else
          echo "âœ… Version ${VERSION} is new on Test PyPI"
        fi

    - name: Build package
      run: |
        echo "ğŸ”§ Building package for Test PyPI..."
        python -m build
        echo "âœ… Package built successfully"
        
        # Show what was built
        ls -la dist/
        echo "ğŸ“¦ Built files:"
        for file in dist/*; do
          echo "  - $(basename $file) ($(du -h $file | cut -f1))"
        done

    - name: Verify package
      run: |
        echo "ğŸ” Verifying package contents..."
        twine check dist/*
        echo "âœ… Package verification passed"

    - name: Test installation (dry run)
      run: |
        echo "ğŸ§ª Testing package installation..."
        
        # Create a temporary virtual environment to test installation
        python -m venv test_env
        source test_env/bin/activate
        
        # Install the built package
        pip install dist/*.whl
        
        # Test basic import
        python -c "
        try:
            import ambivo_agents
            print('âœ… Package imports successfully')
            version = getattr(ambivo_agents, '__version__', 'unknown')
            print(f'ğŸ“¦ Package version: {version}')
            
            # Test basic agent creation (without API keys)
            try:
                from ambivo_agents import KnowledgeBaseAgent
                print('âœ… Agent classes import successfully')
            except Exception as e:
                print(f'âš ï¸ Agent import issue: {e}')
                print('â„¹ï¸ This is expected without configuration')
                
        except ImportError as e:
            print(f'âŒ Import test failed: {e}')
            exit(1)
        "
        
        # Cleanup
        deactivate
        rm -rf test_env

    - name: Publish to Test PyPI
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.TEST_PYPI_API_TOKEN }}  # Direct secret access
        TWINE_REPOSITORY_URL: https://test.pypi.org/legacy/
      run: |
        echo "ğŸš€ Publishing to Test PyPI..."
        echo "ğŸ”‘ Using token from 'testpypi' environment"
        echo "ğŸŒ Repository: https://test.pypi.org/legacy/"
        
        # Verify we have the token
        if [ -z "$TWINE_PASSWORD" ]; then
          echo "âŒ TWINE_PASSWORD is empty!"
          echo "ğŸ’¡ Make sure you have the correct secret configured:"
          echo "   - Secret name: TEST_PYPI_API_TOKEN"
          echo "   - Environment: testpypi"
          exit 1
        fi
        
        # Upload to Test PyPI
        twine upload dist/* --verbose
        
        echo "âœ… Package published to Test PyPI successfully!"

    - name: Verify Test PyPI publication
      run: |
        echo "ğŸ” Verifying package was published to Test PyPI..."
        
        # Wait a moment for PyPI to process
        sleep 10
        
        TAG="${{ steps.target.outputs.tag }}"
        VERSION="${TAG#v}"
        
        if pip index versions ambivo-agents --index-url https://test.pypi.org/simple/ 2>/dev/null | grep -q "${VERSION}"; then
          echo "âœ… Package verified on Test PyPI"
        else
          echo "âš ï¸ Package not yet visible on Test PyPI (may take a few minutes)"
        fi

    - name: Create GitHub Release (Pre-release)
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.target.outputs.tag }}
        name: Release ${{ steps.target.outputs.tag }} (Test)
        body: |
          ## ğŸ§ª Ambivo Agents ${{ steps.target.outputs.tag }} (Test Release)
          
          **Published to: Test PyPI ONLY**
          
          ### ğŸ“¦ Installation
          
          ```bash
          ${{ steps.target.outputs.install_cmd }}
          ```
          
          ### âš ï¸ Important
          
          This is a **test release** published to Test PyPI for validation.
          - Use this for testing and validation only
          - Production installations should wait for the stable release
          - This version is NOT available on Production PyPI
          
          ### ğŸ”§ What's New
          
          - Package published to Test PyPI for testing
          - All integration tests passed
          - See [commit history](https://github.com/ambivo-corp/ambivo-agents/commits/${{ steps.target.outputs.tag }}) for detailed changes
          
          ### ğŸš€ Quick Start
          
          ```python
          from ambivo_agents import KnowledgeBaseAgent
          
          # Create agent with explicit context
          agent, context = KnowledgeBaseAgent.create(user_id="your_user")
          print(f"Agent {agent.agent_id} ready!")
          
          # Use agent...
          await agent.cleanup_session()
          ```
          
          ### ğŸ”— Links
          
          - **Test PyPI Package**: https://test.pypi.org/project/ambivo-agents/
          - **Environment**: `testpypi` (testing only)
          
          ### â¡ï¸ Next Steps
          
          After testing this version, create a stable release tag (e.g., `v1.0.0`) to publish to Production PyPI.
          
          ---
          
          **Built by the Ambivo team**
        draft: false
        prerelease: true

    - name: Test release notification
      run: |
        echo "ğŸ§ª TEST RELEASE PUBLISHED!"
        echo "ğŸ“¦ Package: ambivo-agents ${{ steps.target.outputs.tag }}"
        echo "ğŸ”— Test PyPI: https://test.pypi.org/project/ambivo-agents/"
        echo "ğŸ’¡ Test with: ${{ steps.target.outputs.install_cmd }}"
        echo ""
        echo "âš ï¸ This is a TEST RELEASE - not available on Production PyPI"
        echo "ğŸš€ Create a stable tag (e.g., v1.0.0) for Production PyPI"

  # Job 2: Production PyPI (for stable releases ONLY)
  publish-pypi:
    runs-on: ubuntu-latest
    # Static environment name - this is crucial for secret access
    environment: pypi
    # Only run for stable release tags (no beta/alpha/rc)
    if: "!contains(github.ref, '-beta') && !contains(github.ref, '-alpha') && !contains(github.ref, '-rc')"

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine setuptools wheel

    - name: Determine tag and version
      id: target
      run: |
        # Get the tag from either push event or manual input
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          TAG="${{ github.event.inputs.tag }}"
        else
          TAG="${GITHUB_REF#refs/tags/}"
        fi
        
        echo "tag=${TAG}" >> $GITHUB_OUTPUT
        echo "environment=pypi" >> $GITHUB_OUTPUT
        echo "pypi_name=Production PyPI" >> $GITHUB_OUTPUT
        echo "pypi_url=https://pypi.org/project/ambivo-agents/" >> $GITHUB_OUTPUT
        echo "repository_url=https://upload.pypi.org/legacy/" >> $GITHUB_OUTPUT
        echo "is_prerelease=false" >> $GITHUB_OUTPUT
        echo "install_cmd=pip install ambivo-agents==${TAG}" >> $GITHUB_OUTPUT
        
        echo "ğŸ¯ Target: Production PyPI (Stable Release)"
        echo "ğŸ·ï¸ Version: ${TAG}"
        echo "ğŸŒ Environment: pypi"
        echo "ğŸŒ Repository URL: https://upload.pypi.org/legacy/"

    - name: Verify version tag
      run: |
        TAG="${{ steps.target.outputs.tag }}"
        echo "ğŸ·ï¸ Publishing stable version: ${TAG}"
        
        # Check if this is a valid stable version tag (no pre-release suffixes)
        if [[ ${TAG} =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "âœ… Valid stable version tag detected"
        else
          echo "âŒ Invalid stable version tag format: ${TAG}"
          echo "Expected format: v1.0.0 (no pre-release suffixes like -beta, -alpha, -rc)"
          echo "ğŸ’¡ Use tags like v1.0.0-beta for Test PyPI, v1.0.0 for Production PyPI"
          exit 1
        fi

    - name: Check if version already exists
      run: |
        TAG="${{ steps.target.outputs.tag }}"
        PACKAGE_NAME="ambivo-agents"
        
        # Remove 'v' prefix for PyPI version check
        VERSION="${TAG#v}"
        
        echo "ğŸ” Checking if version ${VERSION} already exists on Production PyPI..."
        
        # Check Production PyPI (fail if version exists)
        if pip index versions ${PACKAGE_NAME} 2>/dev/null | grep -q "${VERSION}"; then
          echo "âŒ Version ${VERSION} already exists on Production PyPI"
          echo "ğŸ’¡ You need to increment the version number"
          echo "ğŸ”— Existing versions: https://pypi.org/project/ambivo-agents/#history"
          exit 1
        else
          echo "âœ… Version ${VERSION} is new on Production PyPI"
        fi

    - name: Build package
      run: |
        echo "ğŸ”§ Building package for Production PyPI..."
        python -m build
        echo "âœ… Package built successfully"
        
        # Show what was built
        ls -la dist/
        echo "ğŸ“¦ Built files:"
        for file in dist/*; do
          echo "  - $(basename $file) ($(du -h $file | cut -f1))"
        done

    - name: Verify package
      run: |
        echo "ğŸ” Verifying package contents..."
        twine check dist/*
        echo "âœ… Package verification passed"

    - name: Test installation (dry run)
      run: |
        echo "ğŸ§ª Testing package installation..."
        
        # Create a temporary virtual environment to test installation
        python -m venv test_env
        source test_env/bin/activate
        
        # Install the built package
        pip install dist/*.whl
        
        # Test basic import
        python -c "
        try:
            import ambivo_agents
            print('âœ… Package imports successfully')
            version = getattr(ambivo_agents, '__version__', 'unknown')
            print(f'ğŸ“¦ Package version: {version}')
            
            # Test basic agent creation (without API keys)
            try:
                from ambivo_agents import KnowledgeBaseAgent
                print('âœ… Agent classes import successfully')
            except Exception as e:
                print(f'âš ï¸ Agent import issue: {e}')
                print('â„¹ï¸ This is expected without configuration')
                
        except ImportError as e:
            print(f'âŒ Import test failed: {e}')
            exit(1)
        "
        
        # Cleanup
        deactivate
        rm -rf test_env

    - name: Wait for approval (Production only)
      run: |
        echo "ğŸ›¡ï¸ Production deployment detected"
        echo "â¸ï¸ Waiting for manual approval..."
        echo "ğŸ‘¥ Reviewers will be notified to approve this deployment"
        echo "ğŸ·ï¸ Version: ${{ steps.target.outputs.tag }}"
        echo "ğŸ¯ Target: Production PyPI"
        echo ""
        echo "â„¹ï¸ This is a STABLE RELEASE that will be publicly available"

    - name: Publish to Production PyPI
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}  # Direct secret access
        TWINE_REPOSITORY_URL: https://upload.pypi.org/legacy/
      run: |
        echo "ğŸš€ Publishing to Production PyPI..."
        echo "ğŸ”‘ Using token from 'pypi' environment"
        echo "ğŸŒ Repository: https://upload.pypi.org/legacy/"
        
        # Verify we have the token
        if [ -z "$TWINE_PASSWORD" ]; then
          echo "âŒ TWINE_PASSWORD is empty!"
          echo "ğŸ’¡ Make sure you have the correct secret configured:"
          echo "   - Secret name: PYPI_API_TOKEN"
          echo "   - Environment: pypi"
          exit 1
        fi
        
        # Upload to Production PyPI
        twine upload dist/* --verbose
        
        echo "âœ… Package published to Production PyPI successfully!"

    - name: Verify Production PyPI publication
      run: |
        echo "ğŸ” Verifying package was published to Production PyPI..."
        
        # Wait a moment for PyPI to process
        sleep 10
        
        TAG="${{ steps.target.outputs.tag }}"
        VERSION="${TAG#v}"
        
        if pip index versions ambivo-agents 2>/dev/null | grep -q "${VERSION}"; then
          echo "âœ… Package verified on Production PyPI"
        else
          echo "âš ï¸ Package not yet visible on Production PyPI (may take a few minutes)"
        fi

    - name: Create GitHub Release (Stable)
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.target.outputs.tag }}
        name: Release ${{ steps.target.outputs.tag }} (Stable)
        body: |
          ## ğŸ‰ Ambivo Agents ${{ steps.target.outputs.tag }} (Stable Release)
          
          **Published to: Production PyPI**
          
          ### ğŸ“¦ Installation
          
          ```bash
          ${{ steps.target.outputs.install_cmd }}
          ```
          
          ### âœ… Production Ready
          
          This is a **stable release** published to Production PyPI.
          - Ready for production use
          - Fully tested and validated
          - Available worldwide via standard pip install
          
          ### ğŸ”§ What's New
          
          - Package published to Production PyPI
          - All integration tests passed
          - See [commit history](https://github.com/ambivo-corp/ambivo-agents/commits/${{ steps.target.outputs.tag }}) for detailed changes
          
          ### ğŸš€ Quick Start
          
          ```python
          from ambivo_agents import KnowledgeBaseAgent
          
          # Create agent with explicit context
          agent, context = KnowledgeBaseAgent.create(user_id="your_user")
          print(f"Agent {agent.agent_id} ready!")
          
          # Use agent...
          await agent.cleanup_session()
          ```
          
          ### ğŸ“š Documentation
          
          - [README](https://github.com/ambivo-corp/ambivo-agents#readme)
          - [Examples](https://github.com/ambivo-corp/ambivo-agents/blob/main/one_liner_examples.py)
          
          ### ğŸ”— Links
          
          - **PyPI Package**: https://pypi.org/project/ambivo-agents/
          - **Environment**: `pypi` (production)
          
          ---
          
          **Built by the Ambivo team**
        draft: false
        prerelease: false

    - name: Production notification
      run: |
        echo "ğŸ‰ STABLE RELEASE PUBLISHED TO PRODUCTION!"
        echo "ğŸ“¦ Package: ambivo-agents ${{ steps.target.outputs.tag }}"
        echo "ğŸ”— Production PyPI: https://pypi.org/project/ambivo-agents/"
        echo "ğŸŒŸ This is now available worldwide for installation!"
        echo "ğŸ’¡ Install with: ${{ steps.target.outputs.install_cmd }}"

  # Summary job (runs after either job completes)
  summary:
    runs-on: ubuntu-latest
    needs: [publish-testpypi, publish-pypi]
    if: always()

    steps:
    - name: Workflow Summary
      run: |
        echo "ğŸ“Š Publish Workflow Summary:"
        echo ""
        
        if [ "${{ needs.publish-testpypi.result }}" = "success" ]; then
          echo "âœ… Test PyPI: Published successfully"
          echo "   ğŸ”— https://test.pypi.org/project/ambivo-agents/"
          echo "   ğŸ“ Pre-release testing completed"
        elif [ "${{ needs.publish-testpypi.result }}" = "skipped" ]; then
          echo "â­ï¸ Test PyPI: Skipped (stable release tag)"
        else
          echo "âŒ Test PyPI: Failed"
        fi
        
        if [ "${{ needs.publish-pypi.result }}" = "success" ]; then
          echo "âœ… Production PyPI: Published successfully"
          echo "   ğŸ”— https://pypi.org/project/ambivo-agents/"
          echo "   ğŸ“ Stable release available worldwide"
        elif [ "${{ needs.publish-pypi.result }}" = "skipped" ]; then
          echo "â­ï¸ Production PyPI: Skipped (pre-release tag)"
        else
          echo "âŒ Production PyPI: Failed"
        fi
        
        echo ""
        echo "â„¹ï¸ Publishing Strategy (Option 1 - Safer):"
        echo "   â€¢ Pre-release tags (beta/alpha/rc): Test PyPI ONLY"
        echo "   â€¢ Stable tags (v1.0.0): Production PyPI ONLY"
        echo "   â€¢ Test first, then promote to production"
        echo ""
        echo "ğŸ‰ Workflow complete!"